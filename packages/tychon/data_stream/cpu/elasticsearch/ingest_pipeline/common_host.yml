---
description: Pipeline for common host fields processing
processors:

  - gsub:
      field: tychon.host.mac
      pattern: ':'
      replacement: '-'
      ignore_missing: true
  - split:
      field: tychon.host.mac
      separator: ','
      if: ctx.tychon?.host?.mac instanceof String && ctx.tychon.host.mac != ""
      ignore_missing: true
  - split:
      field: tychon.host.ip
      separator: ','
      if: ctx.tychon?.host?.ip instanceof String && ctx.tychon.host.ip != ""
      ignore_missing: true
  - split:
      field: tychon.host.ipv4
      separator: ','
      if: ctx.tychon?.host?.ipv4 instanceof String && ctx.tychon.host.ipv4 != ""
      ignore_missing: true
  - split:
      field: tychon.host.ipv6
      separator: ','
      if: ctx.tychon?.host?.ipv6 instanceof String && ctx.tychon.host.ipv6 != ""
      ignore_missing: true

  - convert:
      field: tychon.host.uptime
      type: string
      ignore_missing: true
  - gsub:
      description: Truncate decimal part of host.uptime value
      field: tychon.host.uptime
      pattern: '\.\d+$'
      replacement: ""
      ignore_missing: true
  - convert:
      field: tychon.host.uptime
      type: long
      ignore_missing: true

  - set:
      field: tychon.host.domain
      value: ""
      if: ctx.tychon?.host?.domain == null
  - set:
      field: tychon.host.oem.model
      value: ""
      if: ctx.tychon?.host?.oem?.model == null
  - set:
      field: tychon.host.oem.manufacturer
      value: ""
      if: ctx.tychon?.host?.oem?.manufacturer == null

  - remove: 
      field: tychon.host.os.extended_support_license_expiration
      if: ctx.tychon?.host?.os?.extended_support_license_expiration == ''
      ignore_missing: true

  - remove:
      field: tychon.host.cloud
      if: ctx.tychon?.host?.cloud?.hosted != true
      ignore_missing: true

  # ECS fields from the tychon fieldset

  - foreach:
      field: tychon.host.ip
      if: ctx.tychon?.host?.ip instanceof List
      processor:
        append:
          field: related.ip
          value: "{{_ingest._value}}"
          allow_duplicates: false
  - foreach:
      field: tychon.host.ipv4
      if: ctx.tychon?.host?.ipv4 instanceof List
      processor:
        append:
          field: related.ip
          value: "{{_ingest._value}}"
          allow_duplicates: false
  - foreach:
      field: tychon.host.ipv6
      if: ctx.tychon?.host?.ipv6 instanceof List
      processor:
        append:
          field: related.ip
          value: "{{_ingest._value}}"
          allow_duplicates: false
  - append:
      field: related.hosts
      value: "{{tychon.host.domain}}"
      if: ctx.tychon?.host?.domain != null && ctx.tychon.host.domain != ""
      allow_duplicates: false
  - append:
      field: related.hosts
      value: "{{tychon.host.hostname}}"
      if: ctx.tychon?.host?.hostname != null && ctx.tychon.host.hostname != ""
      allow_duplicates: false
  - append:
      field: related.hosts
      value: "{{tychon.host.id}}"
      if: ctx.tychon?.host?.id != null && ctx.tychon.host.id != ""
      allow_duplicates: false

  - set:
      field: host.domain
      copy_from: tychon.host.domain
      ignore_empty_value: true
  - set:
      field: host.hostname
      copy_from: tychon.host.hostname
      ignore_empty_value: true
  - set:
      field: host.id
      copy_from: tychon.host.id
      ignore_empty_value: true
  - set:
      field: host.ip
      copy_from: tychon.host.ip
      ignore_empty_value: true
  - set:
      field: host.mac
      copy_from: tychon.host.mac
      ignore_empty_value: true
  - set:
      field: host.os.family
      copy_from: tychon.host.os.family
      ignore_empty_value: true
  - set:
      field: host.os.name
      copy_from: tychon.host.os.name
      ignore_empty_value: true
  - set:
      field: host.os.platform
      copy_from: tychon.host.os.platform
      ignore_empty_value: true
  - set:
      field: host.os.version
      copy_from: tychon.host.os.version
      ignore_empty_value: true
  - set:
      field: host.type
      copy_from: tychon.host.type
      ignore_empty_value: true
  - set:
      field: host.uptime
      copy_from: tychon.host.uptime
      ignore_empty_value: true
